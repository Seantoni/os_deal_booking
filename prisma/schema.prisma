generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model BookingRequest {
  id                     String                  @id @default(cuid())
  name                   String
  category               String?
  parentCategory         String?
  subCategory1           String?
  subCategory2           String?
  subCategory3           String?
  merchant               String?
  businessEmail          String
  startDate              DateTime
  endDate                DateTime
  status                 String                  @default("draft")
  userId                 String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  eventId                String?
  processedAt            DateTime?
  processedBy            String?
  rejectionReason        String?
  accountNumber          String?
  accountType            String?
  additionalComments     String?
  addressAndHours        String?
  bank                   String?
  bankAccountName        String?
  blackoutDates          String?
  businessReview         String?
  campaignDuration       String?
  cancellationPolicy     String?
  commission             String?
  contactDetails         String?
  corregimiento          String?
  district               String?
  exclusivityCondition   String?
  giftVouchers           String?
  hasExclusivity         String?
  hasOtherBranches       String?
  includesTaxes          String?
  isRecurring            String?
  legalName              String?
  marketValidation       String?
  paymentInstructions    String?
  paymentType            String?
  pricingOptions         Json?
  province               String?
  recurringOfferLink     String?
  redemptionContactEmail String?
  redemptionContactName  String?
  redemptionContactPhone String?
  redemptionMethods      Json?
  redemptionMode         String?
  rucDv                  String?
  socialMedia            String?
  validOnHolidays        String?
  vouchersPerPerson      String?
  opportunityId          String?
  dealId                 String?                 @unique
  publicLinkToken        String?                 @unique
  sourceType             String                  @default("internal")
  fieldComments          Json?
  additionalEmails       Json?
  additionalInfo         Json?
  subCategory4           String?
  dealImages             Json?
  aboutCompany           String?
  aboutOffer             String?
  goodToKnow             String?
  whatWeLike             String?
  shortTitle             String?
  offerMargin            String?
  publicRequestLink      PublicRequestLink?      @relation(fields: [publicLinkToken], references: [token])
  deal                   Deal?
  externalApiRequests    ExternalApiRequest[]
  marketingCampaign      MarketingCampaign?

  @@index([businessEmail])
  @@index([dealId])
  @@index([eventId])
  @@index([opportunityId])
  @@index([parentCategory])
  @@index([publicLinkToken])
  @@index([sourceType])
  @@index([status])
  @@index([userId])
}

model Event {
  id               String   @id @default(cuid())
  name             String
  description      String?
  startDate        DateTime
  endDate          DateTime
  userId           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  category         String?
  merchant         String?
  parentCategory   String?
  subCategory1     String?
  subCategory2     String?
  subCategory3     String?
  bookingRequestId String?
  status           String   @default("approved")
  subCategory4     String?

  @@index([bookingRequestId])
  @@index([category])
  @@index([merchant])
  @@index([parentCategory])
  @@index([status])
  @@index([subCategory1])
  @@index([subCategory2])
  @@index([subCategory3])
  @@index([subCategory4])
  @@index([userId])
}

model UserProfile {
  id              String             @id @default(cuid())
  clerkId         String             @unique
  email           String?
  name            String?
  role            String             @default("sales")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  isActive        Boolean            @default(true)
  businessReps    BusinessSalesRep[]

  @@index([clerkId])
  @@index([email])
  @@index([isActive])
  @@index([role])
}

model AccessAuditLog {
  id             String        @id @default(cuid())
  email          String
  action         String
  performedBy    String
  performedAt    DateTime      @default(now())
  notes          String?
  allowedEmailId String?
  allowedEmail   AllowedEmail? @relation(fields: [allowedEmailId], references: [id])

  @@index([action])
  @@index([email])
  @@index([performedAt])
  @@map("access_audit_logs")
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  userName   String?
  userEmail  String?
  action     String
  entityType String
  entityId   String?
  entityName String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([userId])
  @@map("activity_logs")
}

model AllowedEmail {
  id                String              @id @default(cuid())
  email             String              @unique
  isActive          Boolean             @default(true)
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdBy         String
  clerkInvitationId String?
  invitationStatus  String?
  invitedAt         DateTime?
  invitedBy         String?
  invitedRole       String?
  firstName         String?
  lastName          String?
  auditLogs         AccessAuditLog[]

  @@index([email])
  @@index([invitationStatus])
  @@index([isActive])
  @@map("allowed_emails")
}

model BusinessSalesRep {
  id          String      @id @default(cuid())
  businessId  String
  salesRepId  String
  createdAt   DateTime    @default(now())
  business    Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  userProfile UserProfile @relation(fields: [salesRepId], references: [clerkId], onDelete: Cascade)

  @@unique([businessId, salesRepId])
  @@index([businessId])
  @@index([salesRepId])
  @@map("business_sales_reps")
}

model Business {
  id                   String              @id @default(cuid())
  name                 String
  contactName          String
  contactPhone         String
  contactEmail         String
  categoryId           String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  description          String?
  instagram            String?
  ownerId              String?
  salesTeam            String?
  tier                 Int?
  website              String?
  leadId               String?             @unique
  sourceType           String              @default("manual")
  metrics              Json?
  accountManager       String?
  accountNumber        String?
  accountType          String?
  address              String?
  bank                 String?
  beneficiaryName      String?
  corregimiento        String?
  district             String?
  emailPaymentContacts String?
  ere                  String?
  isAsesor             String?
  neighborhood         String?
  osAsesor             String?
  paymentPlan          String?
  province             String?
  razonSocial          String?
  ruc                  String?
  salesType            String?
  osAdminVendorId      String?
  focusPeriod          String?
  focusSetAt           DateTime?
  // Reassignment tracking
  reassignmentStatus      String?   // null (normal), 'pending_reassign', 'pending_removal'
  reassignmentType        String?   // 'reasignar' or 'sacar'
  reassignmentRequestedBy String?   // clerkId of who requested
  reassignmentRequestedAt DateTime?
  reassignmentReason      String?   // required notes explaining the request
  reassignmentPreviousOwner String? // to restore if cancelled
  salesReps            BusinessSalesRep[]
  category             Category?           @relation(fields: [categoryId], references: [id])
  lead                 Lead?
  opportunities        Opportunity[]

  @@index([categoryId])
  @@index([leadId])
  @@index([name])
  @@index([ownerId])
  @@index([reassignmentStatus])
  @@map("businesses")
}

model Category {
  id             String     @id @default(cuid())
  parentCategory String
  subCategory1   String?
  subCategory2   String?
  subCategory3   String?
  categoryKey    String     @unique
  maxDuration    Int        @default(5)
  isActive       Boolean    @default(true)
  displayOrder   Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  subCategory4   String?
  businesses     Business[]
  leads          Lead[]

  @@index([categoryKey])
  @@index([displayOrder])
  @@index([isActive])
  @@index([parentCategory])
  @@map("categories")
}

model CompetitorDealSnapshot {
  id            String         @id @default(cuid())
  dealId        String
  totalSold     Int
  offerPrice    Decimal        @db.Decimal(10, 2)
  originalPrice Decimal        @db.Decimal(10, 2)
  scannedAt     DateTime       @default(now())
  deal          CompetitorDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([scannedAt])
  @@map("competitor_deal_snapshots")
}

model CompetitorDeal {
  id              String                    @id @default(cuid())
  sourceUrl       String                    @unique
  sourceSite      String
  merchantName    String
  dealTitle       String
  originalPrice   Decimal                   @db.Decimal(10, 2)
  offerPrice      Decimal                   @db.Decimal(10, 2)
  discountPercent Int
  totalSold       Int                       @default(0)
  imageUrl        String?
  status          String                    @default("active")
  isTracking      Boolean                   @default(true)
  firstSeenAt     DateTime                  @default(now())
  lastScannedAt   DateTime                  @default(now())
  expiresAt       DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  tag             String?
  snapshots       CompetitorDealSnapshot[]

  @@index([firstSeenAt])
  @@index([isTracking])
  @@index([lastScannedAt])
  @@index([merchantName])
  @@index([sourceSite])
  @@index([status])
  @@map("competitor_deals")
}

model CustomFieldValue {
  id            String      @id @default(cuid())
  customFieldId String
  entityId      String
  entityType    String
  value         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([customFieldId, entityId])
  @@index([customFieldId])
  @@index([entityId])
  @@index([entityType])
  @@map("custom_field_values")
}

model CustomField {
  id           String             @id @default(cuid())
  fieldKey     String             @unique
  label        String
  fieldType    String
  entityType   String
  isRequired   Boolean            @default(false)
  placeholder  String?
  defaultValue String?
  helpText     String?
  options      Json?
  displayOrder Int                @default(0)
  showInTable  Boolean            @default(false)
  isActive     Boolean            @default(true)
  createdBy    String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  values       CustomFieldValue[]

  @@index([displayOrder])
  @@index([entityType])
  @@index([fieldKey])
  @@index([isActive])
  @@map("custom_fields")
}

model Deal {
  id               String         @id @default(cuid())
  bookingRequestId String         @unique
  responsibleId    String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  status           String         @default("pendiente_por_asignar")
  opportunityId    String?        @unique
  ereResponsibleId String?
  bookingRequest   BookingRequest @relation(fields: [bookingRequestId], references: [id], onDelete: Cascade)
  opportunity      Opportunity?   @relation(fields: [opportunityId], references: [id])

  @@index([bookingRequestId])
  @@index([ereResponsibleId])
  @@index([opportunityId])
  @@index([responsibleId])
  @@index([status])
  @@map("deals")
}

model ExternalApiRequest {
  id               String          @id @default(cuid())
  endpoint         String
  method           String          @default("POST")
  requestBody      Json?
  headers          Json?
  statusCode       Int?
  responseBody     Json?
  responseRaw      String?
  success          Boolean         @default(false)
  errorMessage     String?
  externalId       Int?
  bookingRequestId String?
  userId           String?
  triggeredBy      String?
  durationMs       Int?
  createdAt        DateTime        @default(now())
  bookingRequest   BookingRequest? @relation(fields: [bookingRequestId], references: [id])

  @@index([bookingRequestId])
  @@index([createdAt])
  @@index([endpoint])
  @@index([statusCode])
  @@index([success])
  @@index([userId])
  @@map("external_api_requests")
}

model FormFieldConfig {
  id                   String      @id @default(cuid())
  entityType           String
  sectionId            String
  fieldKey             String
  fieldSource          String      @default("builtin")
  displayOrder         Int         @default(0)
  isVisible            Boolean     @default(true)
  isRequired           Boolean     @default(false)
  isReadonly           Boolean     @default(false)
  width                String      @default("full")
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  canEditAfterCreation Boolean     @default(false)
  section              FormSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([entityType, fieldKey])
  @@index([displayOrder])
  @@index([entityType])
  @@index([fieldKey])
  @@index([sectionId])
  @@map("form_field_configs")
}

model FormSection {
  id           String            @id @default(cuid())
  entityType   String
  name         String
  displayOrder Int               @default(0)
  isCollapsed  Boolean           @default(false)
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  fields       FormFieldConfig[]

  @@index([displayOrder])
  @@index([entityType])
  @@index([isActive])
  @@map("form_sections")
}

model Lead {
  id            String    @id @default(cuid())
  name          String
  contactName   String
  contactPhone  String
  contactEmail  String
  categoryId    String?
  responsibleId String?
  stage         String    @default("por_asignar")
  website       String?
  instagram     String?
  description   String?
  source        String?
  notes         String?
  businessId    String?   @unique
  convertedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  business      Business? @relation(fields: [businessId], references: [id])
  category      Category? @relation(fields: [categoryId], references: [id])

  @@index([businessId])
  @@index([categoryId])
  @@index([name])
  @@index([responsibleId])
  @@index([stage])
  @@map("leads")
}

model MarketingCampaign {
  id               String            @id @default(cuid())
  bookingRequestId String            @unique
  doMarketing      Boolean           @default(true)
  skipReason       String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  createdBy        String?
  generatedCopy    String?
  videoScript      String?
  bookingRequest   BookingRequest    @relation(fields: [bookingRequestId], references: [id], onDelete: Cascade)
  options          MarketingOption[]

  @@index([bookingRequestId])
  @@index([doMarketing])
  @@map("marketing_campaigns")
}

model MarketingOptionComment {
  id          String          @id @default(cuid())
  optionId    String
  userId      String
  content     String
  mentions    Json?
  reactions   Json?
  attachments Json?
  isEdited    Boolean         @default(false)
  editedAt    DateTime?
  isDeleted   Boolean         @default(false)
  deletedAt   DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  readBy      Json?
  dismissedBy Json?
  option      MarketingOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@index([optionId, createdAt])
  @@index([userId])
  @@map("marketing_option_comments")
}

model MarketingOption {
  id             String                    @id @default(cuid())
  campaignId     String
  platform       String
  optionType     String
  isPlanned      Boolean                   @default(false)
  isCompleted    Boolean                   @default(false)
  dueDate        DateTime?
  completedAt    DateTime?
  completedBy    String?
  notes          String?
  mediaUrls      Json?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  notesUpdatedAt DateTime?
  notesUpdatedBy String?
  responsibleId  String?
  comments       MarketingOptionComment[]
  campaign       MarketingCampaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, platform, optionType])
  @@index([campaignId])
  @@index([isCompleted])
  @@index([isPlanned])
  @@index([platform])
  @@index([responsibleId])
  @@map("marketing_options")
}

model Opportunity {
  id                   String               @id @default(cuid())
  businessId           String
  stage                String               @default("iniciacion")
  startDate            DateTime
  closeDate            DateTime?
  notes                String?
  userId               String
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  lastActivityDate     DateTime?
  nextActivityDate     DateTime?
  responsibleId        String?
  hasRequest           Boolean              @default(false)
  bookingRequestId     String?
  dealId               String?              @unique
  lostReason           String?
  name                 String?
  deal                 Deal?
  business             Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  comments             OpportunityComment[]
  tasks                Task[]

  @@index([bookingRequestId])
  @@index([businessId])
  @@index([dealId])
  @@index([responsibleId])
  @@index([stage])
  @@index([userId])
  @@map("opportunities")
}

model OpportunityComment {
  id            String      @id @default(cuid())
  opportunityId String
  userId        String
  content       String
  mentions      Json?
  reactions     Json?
  isEdited      Boolean     @default(false)
  editedAt      DateTime?
  isDeleted     Boolean     @default(false)
  deletedAt     DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  readBy        Json?
  dismissedBy   Json?
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId, createdAt])
  @@index([userId])
  @@map("opportunity_comments")
}

model PublicRequestLink {
  id             String          @id @default(cuid())
  token          String          @unique
  createdBy      String
  recipientEmail String
  isUsed         Boolean         @default(false)
  usedAt         DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  bookingRequest BookingRequest?

  @@index([createdBy])
  @@index([isUsed])
  @@index([recipientEmail])
  @@index([token])
  @@map("public_request_links")
}

model SavedFilter {
  id         String   @id @default(cuid())
  name       String
  entityType String
  filters    Json
  createdBy  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([createdBy])
  @@index([entityType])
  @@map("saved_filters")
}

model Setting {
  id                         String   @id @default("default")
  minDailyLaunches           Int      @default(5)
  maxDailyLaunches           Int      @default(13)
  merchantRepeatDays         Int      @default(30)
  categoryDurations          Json
  businessExceptions         Json
  customCategories           Json
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  updatedBy                  String?
  additionalInfoMappings     Json?
  requestFormFields          Json?
  hiddenCategoryPaths        Json?
  externalApiSectionMappings Json?

  @@map("settings")
}

model Task {
  id            String      @id @default(cuid())
  opportunityId String
  category      String
  title         String
  date          DateTime
  completed     Boolean     @default(false)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([date])
  @@index([opportunityId])
  @@map("tasks")
}
